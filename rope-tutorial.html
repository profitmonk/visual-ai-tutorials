<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoPE Tutorial</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            background: #ffffff;
            color: #2d2d2d;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .step {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border-left: 4px solid #2d2d2d;
        }
        
        .example-box {
            background: #2d2d2d;
            color: #e0e0e0;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            border: 1px solid #4a4a4a;
        }
        
        .highlight {
            background: #f8f9fa;
            color: #2d2d2d;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .matrix {
            display: inline-block;
            text-align: center;
            margin: 10px;
            padding: 10px;
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            color: #2d2d2d;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        button {
            background: #2d2d2d;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: #ffffff;
            color: #2d2d2d;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .attention-viz {
            display: grid;
            gap: 2px;
            margin: 15px 0;
        }
        
        .attention-cell {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        h1, h2, h3 {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .warning {
            background: rgba(255, 152, 0, 0.2);
            border-left: 4px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåÄ RoPE: Rotary Position Embedding Tutorial</h1>
        <p>Learn how the same transformer model behaves differently with various context lengths!</p>
    </div>

    <div class="container">
        <h2>üìö Step 1: Understanding Basic RoPE</h2>
        <div class="step">
            <h3>What is RoPE?</h3>
            <p>RoPE (Rotary Position Embedding) encodes position by <span class="highlight">rotating</span> token embeddings in high-dimensional space. Instead of adding position vectors, it rotates them!</p>
            
            <div class="example-box">
                <strong>Key Formula:</strong><br>
                Œ∏_i = 10000^(-2i/d) where i = dimension pair index<br>
                For position m: rotate by angle m √ó Œ∏_i
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üîß Step 2: Interactive RoPE Calculator</h2>
        
        <div class="controls">
            <div class="control-group">
                <label>Model Dimension (d):</label>
                <select id="modelDim">
                    <option value="4">4 (toy model)</option>
                    <option value="8">8</option>
                    <option value="16">16</option>
                </select>
            </div>
            <div class="control-group">
                <label>Sequence Length:</label>
                <input type="number" id="seqLength" value="4" min="2" max="10">
            </div>
            <div class="control-group">
                <label>Base (Œ∏ base):</label>
                <input type="number" id="base" value="10000" min="100" max="100000">
            </div>
        </div>
        
        <button onclick="calculateRoPE()">üîÑ Calculate RoPE Rotations</button>
        
        <div id="ropeResults"></div>
    </div>

    <div class="container">
        <h2>üéØ Step 3: Context Length Impact</h2>
        
        <div class="comparison">
            <div>
                <h3>Short Context (4 tokens)</h3>
                <div id="shortContext"></div>
            </div>
            <div>
                <h3>Long Context (8 tokens)</h3>
                <div id="longContext"></div>
            </div>
        </div>
        
        <button onclick="compareContexts()">üìä Compare Context Lengths</button>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Key Insight:</strong> Notice how the same Q, K, V transformation matrices work for both contexts, but the rotational patterns differ!
        </div>
    </div>

    <div class="container">
        <h2>üßÆ Step 4: Attention Score Calculation</h2>
        
        <div class="step">
            <h3>How RoPE Affects Attention</h3>
            <p>When we compute attention scores (Q √ó K^T), the rotational encoding creates <span class="highlight">relative position awareness</span>.</p>
        </div>
        
        <button onclick="visualizeAttention()">üé® Visualize Attention Patterns</button>
        <div id="attentionViz"></div>
    </div>

    <div class="container">
        <h2>üìà Step 5: Context Extension Challenges</h2>
        
        <div class="step">
            <h3>The Problem with Longer Contexts</h3>
            <p>As context length grows beyond training:</p>
            <ul>
                <li>üîÑ <strong>Rotation angles become unfamiliar</strong> - model hasn't seen these angles during training</li>
                <li>üíæ <strong>Memory grows quadratically</strong> - attention matrix becomes huge</li>
                <li>‚ö° <strong>Computation explodes</strong> - O(n¬≤) complexity</li>
            </ul>
        </div>
        
        <button onclick="showScalingProblem()">üìâ Demonstrate Scaling Issues</button>
        <div id="scalingDemo"></div>
    </div>

    <script>
        function calculateRoPE() {
            const d = parseInt(document.getElementById('modelDim').value);
            const seqLen = parseInt(document.getElementById('seqLength').value);
            const base = parseInt(document.getElementById('base').value);
            
            let results = '<div class="step"><h3>RoPE Calculations</h3>';
            
            // Calculate theta values
            results += '<div class="example-box"><strong>Step 1: Calculate Œ∏ values</strong><br>';
            const thetas = [];
            for (let i = 0; i < d/2; i++) {
                const theta = Math.pow(base, -2*i/d);
                thetas.push(theta);
                results += `Œ∏_${i} = ${base}^(-${2*i}/${d}) = ${theta.toFixed(6)}<br>`;
            }
            results += '</div>';
            
            // Show rotation angles for each position
            results += '<div class="example-box"><strong>Step 2: Rotation angles for each position</strong><br>';
            results += '<table style="width:100%; text-align: center; margin: 10px 0;">';
            results += '<tr><th>Position</th>';
            for (let i = 0; i < d/2; i++) {
                results += `<th>Angle ${i}</th>`;
            }
            results += '</tr>';
            
            for (let pos = 0; pos < seqLen; pos++) {
                results += `<tr><td><strong>${pos}</strong></td>`;
                for (let i = 0; i < d/2; i++) {
                    const angle = pos * thetas[i];
                    results += `<td>${angle.toFixed(3)}</td>`;
                }
                results += '</tr>';
            }
            results += '</table></div>';
            
            results += '<div class="example-box"><strong>Key Observation:</strong><br>';
            results += '‚Ä¢ Lower dimensions (higher Œ∏) rotate slower ‚Üí capture long-range patterns<br>';
            results += '‚Ä¢ Higher dimensions (lower Œ∏) rotate faster ‚Üí capture short-range patterns</div>';
            
            results += '</div>';
            document.getElementById('ropeResults').innerHTML = results;
        }
        
        function compareContexts() {
            const shortLen = 4;
            const longLen = 8;
            const d = 4;
            const base = 10000;
            
            function generateContext(length, containerId) {
                let html = '<div class="example-box">';
                html += `<strong>Sequence: ["The", "cat", "sat", "on"${length > 4 ? ', "the", "mat", "very", "quietly"' : ''}]</strong><br><br>`;
                
                // Calculate sample rotations for dimension 0
                html += '<strong>Rotation angles (dim 0):</strong><br>';
                const theta0 = Math.pow(base, 0/d); // = 1
                for (let i = 0; i < length; i++) {
                    const angle = i * theta0;
                    html += `Position ${i}: ${angle.toFixed(3)} radians<br>`;
                }
                
                html += '<br><strong>Memory Requirements:</strong><br>';
                html += `Attention Matrix: ${length} √ó ${length} = ${length * length} entries<br>`;
                html += `Memory scaling: O(n¬≤) = O(${length}¬≤)<br>`;
                
                html += '</div>';
                return html;
            }
            
            document.getElementById('shortContext').innerHTML = generateContext(shortLen, 'shortContext');
            document.getElementById('longContext').innerHTML = generateContext(longLen, 'longContext');
        }
        
        function visualizeAttention() {
            const seqLen = 5;
            let html = '<div class="step">';
            html += '<h3>Attention Matrix Visualization</h3>';
            html += '<p>Each cell shows attention score between token pairs. Brighter = higher attention.</p>';
            
            // Create attention matrix visualization
            html += '<div class="attention-viz" style="grid-template-columns: repeat(' + (seqLen + 1) + ', 1fr);">';
            
            // Header row
            html += '<div class="attention-cell" style="background: rgba(255,255,255,0.2);"></div>';
            for (let j = 0; j < seqLen; j++) {
                html += `<div class="attention-cell" style="background: rgba(255,255,255,0.2);">${j}</div>`;
            }
            
            // Data rows
            for (let i = 0; i < seqLen; i++) {
                html += `<div class="attention-cell" style="background: rgba(255,255,255,0.2);">${i}</div>`;
                for (let j = 0; j < seqLen; j++) {
                    // Simulate attention scores (higher for closer positions)
                    const distance = Math.abs(i - j);
                    const attention = Math.exp(-distance * 0.5);
                    const intensity = attention * 255;
                    html += `<div class="attention-cell" style="background: rgba(255,${Math.floor(intensity)},0,0.8);">${attention.toFixed(2)}</div>`;
                }
            }
            html += '</div>';
            
            html += '<div class="example-box">';
            html += '<strong>Notice:</strong> RoPE creates position-dependent attention patterns.<br>';
            html += '‚Ä¢ Diagonal elements (self-attention) are typically high<br>';
            html += '‚Ä¢ Adjacent positions have stronger connections<br>';
            html += '‚Ä¢ Pattern depends on relative distances, not absolute positions';
            html += '</div>';
            
            html += '</div>';
            document.getElementById('attentionViz').innerHTML = html;
        }
        
        function showScalingProblem() {
            let html = '<div class="step">';
            html += '<h3>The Quadratic Scaling Problem</h3>';
            
            const contexts = [
                { len: 1000, name: "1K tokens" },
                { len: 4000, name: "4K tokens (original)" },
                { len: 32000, name: "32K tokens" },
                { len: 200000, name: "200K tokens" },
                { len: 1000000, name: "1M tokens" }
            ];
            
            html += '<table style="width:100%; text-align: center; margin: 15px 0;">';
            html += '<tr><th>Context Size</th><th>Attention Matrix</th><th>Memory (GB)</th><th>Compute Ratio</th></tr>';
            
            const baseCompute = contexts[1].len * contexts[1].len; // 4K baseline
            
            for (let ctx of contexts) {
                const matrixSize = ctx.len * ctx.len;
                const memoryGB = (matrixSize * 4) / (1024 * 1024 * 1024); // 4 bytes per float32
                const computeRatio = matrixSize / baseCompute;
                
                html += '<tr>';
                html += `<td><strong>${ctx.name}</strong></td>`;
                html += `<td>${ctx.len} √ó ${ctx.len}</td>`;
                html += `<td>${memoryGB.toFixed(2)}</td>`;
                html += `<td>${computeRatio.toFixed(1)}x</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            html += '<div class="warning">';
            html += '<strong>üö® The Crisis:</strong><br>';
            html += '‚Ä¢ 1M context = 1 trillion attention scores!<br>';
            html += '‚Ä¢ Memory requirements grow from MB to TB<br>';
            html += '‚Ä¢ This is why context extension needs clever tricks, not just bigger computers';
            html += '</div>';
            
            html += '</div>';
            document.getElementById('scalingDemo').innerHTML = html;
        }
        
        // Initialize with default calculations
        document.addEventListener('DOMContentLoaded', function() {
            calculateRoPE();
            compareContexts();
        });
    </script>
</body>
</html>
