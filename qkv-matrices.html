<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q, K, V Matrix Correlation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            background: #ffffff;
            color: #2d2d2d;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .nav-bar {
            background: #2d2d2d;
            color: white;
            padding: 15px 30px;
            border-radius: 15px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-home {
            background: #ffffff;
            color: #2d2d2d;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .nav-home:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .nav-title {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .matrix-visual {
            display: grid;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        
        .matrix-row {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .matrix {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            font-family: 'Courier New', monospace;
            border: 2px solid rgba(255, 255, 255, 0.3);
            min-width: 120px;
        }
        
        .matrix-label {
            font-weight: bold;
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .matrix-size {
            font-size: 18px;
            font-weight: bold;
            color: #87CEEB;
        }
        
        .arrow {
            font-size: 24px;
            color: #4CAF50;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: #ffffff;
            color: #2d2d2d;
            font-weight: bold;
        }
        
        button {
            background: #2d2d2d;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .highlight-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .scenario {
            background: #ffffff;
            border: 1px solid #e9ecef;
            padding: 20px;
            border-radius: 15px;
        }
        
        .step-by-step {
            background: #ffffff;
            border-left: 4px solid #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #e9ecef;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2d2d2d;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <div class="nav-title">üéØ Q, K, V Matrix Dimensions Tutorial</div>
        <a href="index.html" class="nav-home">üè† Home</a>
    </div>

    <div class="container">
        <h1>üéØ Q, K, V Matrix Sizes: d vs m Correlation</h1>
        <p>Understanding how model dimension (d) and sequence position (m) affect matrix sizes</p>
        
        <h2>üèõÔ∏è Major Model Architectures Comparison</h2>
        <table id="modelArchTable" style="margin: 20px 0;">
            <tr>
                <th>Model</th>
                <th>Model Dim (d)</th>
                <th>Heads</th>
                <th>Head Dim</th>
                <th>Layers</th>
                <th>Context Length</th>
                <th>Parameters</th>
            </tr>
            <tr>
                <td><strong>GPT-4</strong></td>
                <td>12,288</td>
                <td>96</td>
                <td>128</td>
                <td>120</td>
                <td>128K</td>
                <td>~1.7T</td>
            </tr>
            <tr>
                <td><strong>Claude Sonnet 4</strong></td>
                <td>~5,120</td>
                <td>40</td>
                <td>128</td>
                <td>~64</td>
                <td>200K ‚Üí 1M</td>
                <td>~200B</td>
            </tr>
            <tr>
                <td><strong>Gemini 2.5 Pro</strong></td>
                <td>~8,192</td>
                <td>64</td>
                <td>128</td>
                <td>~80</td>
                <td>2M</td>
                <td>~500B</td>
            </tr>
            <tr>
                <td><strong>DeepSeek V3</strong></td>
                <td>7,168</td>
                <td>128</td>
                <td>128</td>
                <td>61</td>
                <td>128K</td>
                <td>671B</td>
            </tr>
            <tr>
                <td><strong>LLaMA 3.1 70B</strong></td>
                <td>8,192</td>
                <td>64</td>
                <td>128</td>
                <td>80</td>
                <td>128K</td>
                <td>70.6B</td>
            </tr>
            <tr>
                <td><strong>Qwen 2.5 72B</strong></td>
                <td>8,192</td>
                <td>64</td>
                <td>128</td>
                <td>80</td>
                <td>128K</td>
                <td>72.7B</td>
            </tr>
        </table>
        
        <div class="highlight-box">
            <strong>üìä Key Observations:</strong><br>
            ‚Ä¢ All modern models converge on <strong>head_dim = 128</strong> (sweet spot for efficiency)<br>
            ‚Ä¢ Model dimension (d) = num_heads √ó head_dim in most cases<br>
            ‚Ä¢ Context length varies dramatically, but Q/K/V transformation matrices stay the same size!<br>
            ‚Ä¢ Parameter count grows with d¬≤, layers, and vocabulary size
        </div>
    </div>

    <div class="container">
        <h2>üîß Interactive Matrix Size Calculator</h2>
        
        <div class="controls">
            <div class="control-group">
                <label><strong>Model Dimension (d):</strong></label>
                <select id="modelDim">
                    <option value="64">64 (tiny)</option>
                    <option value="256">256 (small)</option>
                    <option value="512">512 (medium)</option>
                    <option value="1024">1024 (large)</option>
                    <option value="4096">4096 (GPT-scale)</option>
                </select>
            </div>
            <div class="control-group">
                <label><strong>Sequence Length (max m+1):</strong></label>
                <input type="number" id="seqLength" value="4" min="1" max="100">
            </div>
            <div class="control-group">
                <label><strong>Head Dimension:</strong></label>
                <select id="headDim">
                    <option value="64">64</option>
                    <option value="128">128</option>
                </select>
            </div>
        </div>
        
        <button onclick="calculateMatrixSizes()">üìä Calculate Matrix Sizes</button>
        
        <div id="matrixResults"></div>
    </div>

    <div class="container">
        <h2>üìê Step-by-Step Matrix Construction</h2>
        
        <div class="step-by-step">
            <h3>üéØ The Key Insight</h3>
            <p><strong>d</strong> determines the <em>transformation matrix</em> sizes (learned parameters)</p>
            <p><strong>m</strong> determines the <em>resulting tensor</em> sizes (per-sequence computations)</p>
        </div>
        
        <div id="stepByStep"></div>
    </div>

    <div class="container">
        <h2>üîÑ Context Length Comparison</h2>
        
        <div class="comparison-grid">
            <div class="scenario">
                <h3>üîµ Short Context (4 tokens)</h3>
                <div id="shortScenario"></div>
            </div>
            <div class="scenario">
                <h3>üî¥ Long Context (1000 tokens)</h3>
                <div id="longScenario"></div>
            </div>
        </div>
        
        <button onclick="compareContexts()">‚ö° Compare Scenarios</button>
    </div>

    <div class="container">
        <h2>üí° Memory & Computation Analysis</h2>
        <div id="memoryAnalysis"></div>
        <button onclick="analyzeMemory()">üßÆ Analyze Memory Usage</button>
    </div>

    <script>
        function calculateMatrixSizes() {
            const d = parseInt(document.getElementById('modelDim').value);
            const seqLen = parseInt(document.getElementById('seqLength').value);
            const dHead = parseInt(document.getElementById('headDim').value);
            
            let html = '<div style="background: #ffffff; border: 1px solid #e9ecef; border-radius: 15px; padding: 20px; margin: 20px 0;">';
            
            // Transformation matrices (learned parameters - FIXED sizes)
            html += '<div class="matrix-row">';
            html += '<h3>üéØ Learned Transformation Matrices (FIXED by d):</h3>';
            html += '</div>';
            
            html += '<div class="matrix-row">';
            html += `<div class="matrix">
                        <div class="matrix-label">W_Q</div>
                        <div class="matrix-size">[${d} √ó ${dHead}]</div>
                     </div>`;
            html += '<div class="arrow">‚Üí</div>';
            html += `<div class="matrix">
                        <div class="matrix-label">W_K</div>
                        <div class="matrix-size">[${d} √ó ${dHead}]</div>
                     </div>`;
            html += '<div class="arrow">‚Üí</div>';
            html += `<div class="matrix">
                        <div class="matrix-label">W_V</div>
                        <div class="matrix-size">[${d} √ó ${dHead}]</div>
                     </div>`;
            html += '</div>';
            
            html += '<div class="highlight-box">';
            html += '<strong>üîë Key Point:</strong> These transformation matrices are learned during training and their sizes NEVER change, regardless of sequence length!';
            html += '</div>';
            
            // Input and resulting matrices (vary by sequence length)
            html += '<div class="matrix-row">';
            html += '<h3>üìè Per-Sequence Tensors (VARY by m):</h3>';
            html += '</div>';
            
            html += '<div class="matrix-row">';
            html += `<div class="matrix">
                        <div class="matrix-label">Input Embeddings</div>
                        <div class="matrix-size">[${seqLen} √ó ${d}]</div>
                     </div>`;
            html += '<div class="arrow">√ó</div>';
            html += `<div class="matrix">
                        <div class="matrix-label">W_Q</div>
                        <div class="matrix-size">[${d} √ó ${dHead}]</div>
                     </div>`;
            html += '<div class="arrow">=</div>';
            html += `<div class="matrix">
                        <div class="matrix-label">Q</div>
                        <div class="matrix-size">[${seqLen} √ó ${dHead}]</div>
                     </div>`;
            html += '</div>';
            
            html += '<div class="matrix-row">';
            html += `<div class="matrix">
                        <div class="matrix-label">Q</div>
                        <div class="matrix-size">[${seqLen} √ó ${dHead}]</div>
                     </div>`;
            html += '<div class="arrow">√ó</div>';
            html += `<div class="matrix">
                        <div class="matrix-label">K^T</div>
                        <div class="matrix-size">[${dHead} √ó ${seqLen}]</div>
                     </div>`;
            html += '<div class="arrow">=</div>';
            html += `<div class="matrix" style="border-color: #FF6B6B;">
                        <div class="matrix-label">Attention Scores</div>
                        <div class="matrix-size">[${seqLen} √ó ${seqLen}]</div>
                     </div>`;
            html += '</div>';
            
            html += '<div class="matrix-row">';
            html += `<div class="matrix" style="border-color: #FF6B6B;">
                        <div class="matrix-label">Softmax(Attention)</div>
                        <div class="matrix-size">[${seqLen} √ó ${seqLen}]</div>
                     </div>`;
            html += '<div class="arrow">√ó</div>';
            html += `<div class="matrix">
                        <div class="matrix-label">V</div>
                        <div class="matrix-size">[${seqLen} √ó ${dHead}]</div>
                     </div>`;
            html += '<div class="arrow">=</div>';
            html += `<div class="matrix" style="border-color: #4ECDC4;">
                        <div class="matrix-label">Output</div>
                        <div class="matrix-size">[${seqLen} √ó ${dHead}]</div>
                     </div>`;
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('matrixResults').innerHTML = html;
            
            // Generate step by step
            generateStepByStep(d, seqLen, dHead);
        }
        
        function generateStepByStep(d, seqLen, dHead) {
            let html = '<div class="step-by-step">';
            html += '<h3>üìù Step-by-Step Breakdown</h3>';
            
            html += '<h4>Step 1: Model Architecture (Fixed by d)</h4>';
            html += '<table>';
            html += '<tr><th>Component</th><th>Size</th><th>Memory</th><th>Notes</th></tr>';
            html += `<tr><td>W_Q matrix</td><td>[${d} √ó ${dHead}]</td><td>${(d * dHead * 4 / 1024).toFixed(1)} KB</td><td>Learned during training</td></tr>`;
            html += `<tr><td>W_K matrix</td><td>[${d} √ó ${dHead}]</td><td>${(d * dHead * 4 / 1024).toFixed(1)} KB</td><td>Learned during training</td></tr>`;
            html += `<tr><td>W_V matrix</td><td>[${d} √ó ${dHead}]</td><td>${(d * dHead * 4 / 1024).toFixed(1)} KB</td><td>Learned during training</td></tr>`;
            html += '</table>';
            
            html += '<h4>Step 2: Per-Sequence Computation (Varies by m)</h4>';
            html += '<table>';
            html += '<tr><th>Operation</th><th>Input Size</th><th>Output Size</th><th>Memory</th></tr>';
            html += `<tr><td>Input ‚Üí Q</td><td>[${seqLen} √ó ${d}] √ó [${d} √ó ${dHead}]</td><td>[${seqLen} √ó ${dHead}]</td><td>${(seqLen * dHead * 4 / 1024).toFixed(1)} KB</td></tr>`;
            html += `<tr><td>Input ‚Üí K</td><td>[${seqLen} √ó ${d}] √ó [${d} √ó ${dHead}]</td><td>[${seqLen} √ó ${dHead}]</td><td>${(seqLen * dHead * 4 / 1024).toFixed(1)} KB</td></tr>`;
            html += `<tr><td>Input ‚Üí V</td><td>[${seqLen} √ó ${d}] √ó [${d} √ó ${dHead}]</td><td>[${seqLen} √ó ${dHead}]</td><td>${(seqLen * dHead * 4 / 1024).toFixed(1)} KB</td></tr>`;
            html += `<tr style="background: rgba(255,107,107,0.2);"><td><strong>Q √ó K^T</strong></td><td>[${seqLen} √ó ${dHead}] √ó [${dHead} √ó ${seqLen}]</td><td><strong>[${seqLen} √ó ${seqLen}]</strong></td><td><strong>${(seqLen * seqLen * 4 / 1024).toFixed(1)} KB</strong></td></tr>`;
            html += '</table>';
            
            html += '<h4>Step 3: RoPE Application</h4>';
            html += '<p>For each position m = 0, 1, 2, ..., ' + (seqLen-1) + ':</p>';
            html += '<ul>';
            html += '<li>Calculate rotation angles: Œ∏·µ¢ √ó m for each dimension pair i</li>';
            html += '<li>Apply rotations to Q and K tensors (not W_Q, W_K matrices!)</li>';
            html += '<li>Each position gets unique rotational encoding</li>';
            html += '</ul>';
            
            html += '</div>';
            
            document.getElementById('stepByStep').innerHTML = html;
        }
        
        function compareContexts() {
            const d = 512; // Fixed model dimension
            const dHead = 64;
            
            function generateScenario(seqLen, containerId) {
                let html = '';
                
                html += '<h4>Matrix Sizes:</h4>';
                html += '<table>';
                html += '<tr><th>Matrix</th><th>Size</th></tr>';
                html += `<tr><td>W_Q, W_K, W_V</td><td>[${d} √ó ${dHead}] <em>(same!)</em></td></tr>`;
                html += `<tr><td>Q, K, V</td><td>[${seqLen} √ó ${dHead}]</td></tr>`;
                html += `<tr style="background: rgba(255,107,107,0.2);"><td><strong>Attention</strong></td><td><strong>[${seqLen} √ó ${seqLen}]</strong></td></tr>`;
                html += '</table>';
                
                html += '<h4>RoPE Positions:</h4>';
                html += `<p>m ranges from 0 to ${seqLen-1}</p>`;
                html += '<p>Each position gets rotated by m √ó Œ∏·µ¢</p>';
                
                const attentionMemory = seqLen * seqLen * 4 / (1024 * 1024); // MB
                html += `<h4>Memory Impact:</h4>`;
                html += `<p>Attention matrix: <strong>${attentionMemory.toFixed(2)} MB</strong></p>`;
                
                return html;
            }
            
            document.getElementById('shortScenario').innerHTML = generateScenario(4);
            document.getElementById('longScenario').innerHTML = generateScenario(1000);
        }
        
        function analyzeMemory() {
            const d = 4096; // GPT-scale
            const dHead = 128;
            
            const scenarios = [
                { name: "Training (4K)", len: 4096 },
                { name: "Extended (32K)", len: 32768 },
                { name: "Long (200K)", len: 200000 },
                { name: "Claude 1M", len: 1000000 }
            ];
            
            let html = '<div class="step-by-step">';
            html += '<h3>üßÆ Memory Analysis Across Context Lengths</h3>';
            
            html += '<table>';
            html += '<tr><th>Scenario</th><th>Seq Len</th><th>W_Q/K/V Size</th><th>Q/K/V Size</th><th>Attention Size</th><th>Total Memory</th></tr>';
            
            for (let scenario of scenarios) {
                const transformMemory = d * dHead * 3 * 4 / (1024 * 1024); // 3 matrices, 4 bytes per float
                const qkvMemory = scenario.len * dHead * 3 * 4 / (1024 * 1024);
                const attentionMemory = scenario.len * scenario.len * 4 / (1024 * 1024);
                const totalMemory = transformMemory + qkvMemory + attentionMemory;
                
                html += '<tr>';
                html += `<td><strong>${scenario.name}</strong></td>`;
                html += `<td>${scenario.len.toLocaleString()}</td>`;
                html += `<td>${transformMemory.toFixed(1)} MB</td>`;
                html += `<td>${qkvMemory.toFixed(1)} MB</td>`;
                html += `<td><strong>${attentionMemory.toFixed(1)} MB</strong></td>`;
                html += `<td>${totalMemory.toFixed(1)} MB</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            html += '<div class="highlight-box">';
            html += '<strong>üîç Key Observations:</strong><br>';
            html += '‚Ä¢ W_Q, W_K, W_V sizes are IDENTICAL across all scenarios<br>';
            html += '‚Ä¢ Q, K, V tensor sizes grow linearly with sequence length<br>';
            html += '‚Ä¢ Attention matrix size grows quadratically (the bottleneck!)<br>';
            html += '‚Ä¢ 1M context = 4TB just for attention scores!';
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('memoryAnalysis').innerHTML = html;
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            calculateMatrixSizes();
            compareContexts();
        });
    </script>
</body>
</html>
